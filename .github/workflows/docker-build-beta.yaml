name: "Build Docker image - beta"
description: "Builds the Docker image for the beta release and pushes it to the GitHub Container Registry and Docker Hub. This workflow is triggered on the 1st and 15th day of each month at 00:10 UTC, or manually via workflow_dispatch."
on:
  schedule:
    - cron: "10 0 1,15 * *"
  workflow_dispatch:

permissions:
  contents: read
  packages: write

jobs:
  get_date:
    name: Get current date in RFC 3339
    runs-on: ubuntu-latest
    outputs:
      IMG_DATE: ${{ steps.date.outputs.IMG_DATE }}
    steps:
      - name: Get current date in RFC 3339
        id: date
        run: |
          IMG_DATE=$(date --rfc-3339=seconds | sed 's/ /T/')
          echo "IMG_DATE=${IMG_DATE}" >> $GITHUB_OUTPUT
          echo "The date is $IMG_DATE"

  get_pkg_version:
    name: Get latest package version
    runs-on: ubuntu-latest
    outputs:
      PKG_VER: ${{ steps.version.outputs.PKG_VER }}
    steps:
      - name: Add Brave's APT repo for beta release
        run: |
          sudo curl -fsSLo \
            /usr/share/keyrings/brave-browser-beta-archive-keyring.gpg https://brave-browser-apt-beta.s3.brave.com/brave-browser-beta-archive-keyring.gpg
          echo "deb [signed-by=/usr/share/keyrings/brave-browser-beta-archive-keyring.gpg] https://brave-browser-apt-beta.s3.brave.com/ stable main" | \
            sudo tee -a /etc/apt/sources.list.d/brave-browser-beta.list
          sudo apt-get update -y

      - name: Get package version
        id: version
        run: |
          PKG_VER=$(apt list brave-browser-beta | awk -F'[ /]' '/brave-browser-beta/ {print $3}')
          echo "PKG_VER=${PKG_VER}" >> $GITHUB_OUTPUT
          echo "The package version is $PKG_VER"

  build_push:
    name: Build and push image
    runs-on: ubuntu-latest
    needs: [get_date, get_pkg_version]
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: 'beta'

      - name: Login to GitHub container registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: tibor309
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: tibordev
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image for amd64/arm64
        uses: docker/build-push-action@v6
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          file: ./Dockerfile
          push: true
          build-args: |
            IMAGE_BUILD_DATE=${{ needs.get_date.outputs.IMG_DATE }}
          tags: |
            ghcr.io/tibor309/brave:beta
            ghcr.io/tibor309/brave:${{ needs.get_pkg_version.outputs.PKG_VER }}
            tibordev/brave:beta
            tibordev/brave:${{ needs.get_pkg_version.outputs.PKG_VER }}